{% load i18n %}
<div class="language-switcher">
    <form action="{% url 'set_language' %}" method="post" class="d-inline" id="language-form">
        {% csrf_token %}
        <input name="next" type="hidden" value="{{ request.path }}">
        <div class="language-select-wrapper">
            <select name="language" class="form-select" onchange="submitLanguageForm(this)">
                {% get_current_language as CURRENT_LANGUAGE %}
                {% get_available_languages as LANGUAGES %}
                {% for lang_code, lang_name in LANGUAGES %}
                    <option value="{{ lang_code }}" {% if lang_code == CURRENT_LANGUAGE %}selected{% endif %}>
                        {% if lang_code == 'he' %}עברית
                        {% elif lang_code == 'ar' %}العربية
                        {% elif lang_code == 'zh-hans' %}中文
                        {% else %}English{% endif %}
                    </option>
                {% endfor %}
            </select>
            <i class="bi bi-globe language-icon"></i>
        </div>
    </form>
</div>

<style>
.language-switcher {
    margin-left: 1rem;
    display: inline-block;
}

.language-select-wrapper {
    position: relative;
    display: inline-block;
}

.language-select-wrapper select {
    appearance: none;
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.5rem 2.5rem 0.5rem 1rem;
    font-size: 0.9rem;
    font-weight: 500;
    color: #495057;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    min-width: 120px;
}

.language-select-wrapper select:hover {
    background-color: #f8f9fa;
    border-color: #adb5bd;
}

.language-select-wrapper select:focus {
    outline: none;
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.language-icon {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    pointer-events: none;
    font-size: 1rem;
}

@media (max-width: 768px) {
    .language-switcher {
        margin: 0.5rem 0;
        text-align: center;
        width: 100%;
    }
    
    .language-select-wrapper select {
        width: 100%;
        max-width: 200px;
    }
}
</style>

<script>
function submitLanguageForm(selectElement) {
    const form = document.getElementById('language-form');
    const currentPath = window.location.pathname;
    const currentSearch = window.location.search;
    
    // Get the current path without any language prefix
    let pathWithoutLang = currentPath;
    const langPrefixes = ['/he/', '/ar/', '/en/', '/zh-hans/'];
    
    // Remove any existing language prefix
    for (const prefix of langPrefixes) {
        if (pathWithoutLang.startsWith(prefix)) {
            pathWithoutLang = pathWithoutLang.substring(prefix.length);
            break;
        }
    }
    
    // Ensure the path starts with a slash
    if (!pathWithoutLang.startsWith('/')) {
        pathWithoutLang = '/' + pathWithoutLang;
    }
    
    // If we're at the root, use a slash
    if (pathWithoutLang === '') {
        pathWithoutLang = '/';
    }
    
    // Update the next parameter with the current path and search parameters
    form.querySelector('input[name="next"]').value = pathWithoutLang + currentSearch;
    
    // Add a loading indicator
    selectElement.disabled = true;
    selectElement.style.opacity = '0.7';
    
    // Submit the form
    form.submit();
}
</script> 