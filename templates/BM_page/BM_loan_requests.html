{% extends 'base.html' %}
{% load static %}

{% block title %}ניהול בקשות השאלה - DormitoriesPlus{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/forms.css' %}">
<style>
    .loan-filters,
    .loan-requests {
        margin: 2rem 0;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
    }

    .filter-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .status-summary {
        display: flex;
        gap: 1rem;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .loan-requests-table {
        width: 100%;
        border-collapse: collapse;
    }

    .loan-requests-table th,
    .loan-requests-table td {
        padding: 0.75rem;
        text-align: right;
        border-bottom: 1px solid #ddd;
    }

    .loan-requests-table th {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
    }

    .status-badge.pending {
        background-color: #ffc107;
        color: black;
    }

    .status-badge.approved {
        background-color: #28a745;
        color: white;
    }

    .status-badge.rejected {
        background-color: #dc3545;
        color: white;
    }

    .status-badge.returned {
        background-color: #17a2b8;
        color: white;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-icon {
        padding: 0.5rem;
        background: none;
        border: none;
        cursor: pointer;
        color: #6c757d;
        transition: color 0.3s ease;
    }

    .btn-icon:hover,
    .btn-icon:focus {
        color: #007bff;
    }

    .btn-primary,
    .btn-secondary {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-primary:hover,
    .btn-primary:focus,
    .btn-secondary:hover,
    .btn-secondary:focus {
        opacity: 0.9;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }

    .no-requests {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        position: relative;
        background-color: #fff;
        margin: 10% auto;
        padding: 1.5rem;
        width: 90%;
        max-width: 600px;
        border-radius: 8px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
    }

    .close-btn:hover,
    .close-btn:focus {
        color: #dc3545;
    }

    .request-details dl {
        display: grid;
        grid-template-columns: auto 1fr;
        gap: 0.5rem 1rem;
    }

    .request-details dt {
        font-weight: bold;
        color: #6c757d;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    @media (max-width: 768px) {
        .filter-form {
            grid-template-columns: 1fr;
        }

        .list-header {
            flex-direction: column;
            gap: 1rem;
        }

        .status-summary {
            flex-wrap: wrap;
        }

        .action-buttons {
            flex-wrap: wrap;
        }

        .modal-content {
            width: 95%;
            margin: 5% auto;
        }

        .request-details dl {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="hero">
        <h2>ניהול בקשות השאלה</h2>
        <p>ברוך הבא, {{ user.first_name }} {{ user.last_name }}</p>
    </div>

    <div class="loan-filters" role="region" aria-label="סינון בקשות השאלה">
        <h3>סינון בקשות</h3>
        <form id="filterForm" class="filter-form" role="search" aria-labelledby="filterFormTitle">
            <div class="form-group">
                <label for="status" id="status-label">סטטוס:</label>
                <select id="status" 
                        name="status" 
                        aria-labelledby="status-label">
                    <option value="">כל הסטטוסים</option>
                    <option value="pending">ממתין</option>
                    <option value="approved">אושר</option>
                    <option value="rejected">נדחה</option>
                    <option value="returned">הוחזר</option>
                </select>
            </div>

            <div class="form-group">
                <label for="dateFrom" id="dateFrom-label">מתאריך:</label>
                <input type="date" 
                       id="dateFrom" 
                       name="date_from" 
                       aria-labelledby="dateFrom-label">
            </div>

            <div class="form-group">
                <label for="dateTo" id="dateTo-label">עד תאריך:</label>
                <input type="date" 
                       id="dateTo" 
                       name="date_to" 
                       aria-labelledby="dateTo-label">
            </div>

            <div class="form-group">
                <label for="search" id="search-label">חיפוש:</label>
                <input type="text" 
                       id="search" 
                       name="search" 
                       placeholder="חיפוש לפי שם סטודנט או פריט"
                       aria-labelledby="search-label">
            </div>

            <div class="form-actions">
                <button type="submit" 
                        class="btn-primary" 
                        aria-label="סנן בקשות">
                    סנן
                </button>
                <button type="reset" 
                        class="btn-secondary" 
                        aria-label="נקה סינון">
                    נקה
                </button>
            </div>
        </form>
    </div>

    <div class="loan-requests" role="region" aria-label="רשימת בקשות השאלה">
        <div class="list-header">
            <h3>בקשות השאלה</h3>
            <div class="status-summary" role="status" aria-label="סיכום סטטוסים">
                <span class="status-badge pending" aria-label="ממתין: {{ pending_count }}">
                    ממתין: {{ pending_count }}
                </span>
                <span class="status-badge approved" aria-label="אושר: {{ approved_count }}">
                    אושר: {{ approved_count }}
                </span>
                <span class="status-badge rejected" aria-label="נדחה: {{ rejected_count }}">
                    נדחה: {{ rejected_count }}
                </span>
                <span class="status-badge returned" aria-label="הוחזר: {{ returned_count }}">
                    הוחזר: {{ returned_count }}
                </span>
            </div>
        </div>

        {% if loan_requests %}
        <div class="table-responsive">
            <table class="loan-requests-table" role="grid" aria-label="רשימת בקשות השאלה">
                <thead>
                    <tr>
                        <th scope="col" role="columnheader">מספר בקשה</th>
                        <th scope="col" role="columnheader">סטודנט</th>
                        <th scope="col" role="columnheader">פריט</th>
                        <th scope="col" role="columnheader">תאריך בקשה</th>
                        <th scope="col" role="columnheader">תאריך החזרה</th>
                        <th scope="col" role="columnheader">סטטוס</th>
                        <th scope="col" role="columnheader">פעולות</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in loan_requests %}
                    <tr role="row">
                        <td role="cell">{{ request.id }}</td>
                        <td role="cell">{{ request.student.first_name }} {{ request.student.last_name }}</td>
                        <td role="cell">{{ request.item.name }}</td>
                        <td role="cell">{{ request.request_date|date:"d/m/Y" }}</td>
                        <td role="cell">{{ request.return_date|date:"d/m/Y" }}</td>
                        <td role="cell">
                            <span class="status-badge {{ request.status }}" 
                                  aria-label="סטטוס: {{ request.status }}">
                                {{ request.status }}
                            </span>
                        </td>
                        <td role="cell">
                            <div class="action-buttons" role="group" aria-label="פעולות לבקשה">
                                <button type="button" 
                                        class="btn-icon" 
                                        onclick="showRequestDetails('{{ request.id }}')"
                                        aria-label="הצג פרטי בקשה">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% if request.status == 'pending' %}
                                <button type="button" 
                                        class="btn-icon" 
                                        onclick="approveRequest('{{ request.id }}')"
                                        aria-label="אשר בקשה">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button type="button" 
                                        class="btn-icon" 
                                        onclick="rejectRequest('{{ request.id }}')"
                                        aria-label="דחה בקשה">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                                {% if request.status == 'approved' %}
                                <button type="button" 
                                        class="btn-icon" 
                                        onclick="markAsReturned('{{ request.id }}')"
                                        aria-label="סמן כהוחזר">
                                    <i class="fas fa-undo"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="no-requests">לא נמצאו בקשות השאלה</p>
        {% endif %}
    </div>
</div>

<!-- Request Details Modal -->
<div id="requestDetailsModal" 
     class="modal" 
     role="dialog" 
     aria-labelledby="requestDetailsTitle" 
     aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="requestDetailsTitle">פרטי בקשה</h3>
            <button type="button" 
                    class="close-btn" 
                    onclick="closeModal('requestDetailsModal')"
                    aria-label="סגור חלון">
                &times;
            </button>
        </div>
        <div class="request-details" role="region" aria-label="פרטי בקשה">
            <dl>
                <dt>מספר בקשה:</dt>
                <dd id="detailsRequestId"></dd>
                
                <dt>סטודנט:</dt>
                <dd id="detailsStudent"></dd>
                
                <dt>פריט:</dt>
                <dd id="detailsItem"></dd>
                
                <dt>תאריך בקשה:</dt>
                <dd id="detailsRequestDate"></dd>
                
                <dt>תאריך החזרה:</dt>
                <dd id="detailsReturnDate"></dd>
                
                <dt>סטטוס:</dt>
                <dd id="detailsStatus"></dd>
                
                <dt>הערות:</dt>
                <dd id="detailsNotes"></dd>
            </dl>
        </div>
        <div class="modal-footer">
            <button type="button" 
                    class="btn-secondary" 
                    onclick="closeModal('requestDetailsModal')"
                    aria-label="סגור">
                סגור
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Filter form handling
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const params = new URLSearchParams(formData);
        
        fetch(`/api/loan-requests?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                updateLoanRequestsList(data.requests);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('אירעה שגיאה בטעינת הבקשות');
            });
    });

    // Update loan requests list
    function updateLoanRequestsList(requests) {
        const tbody = document.querySelector('.loan-requests-table tbody');
        tbody.innerHTML = '';
        
        if (requests.length === 0) {
            document.querySelector('.no-requests').style.display = 'block';
            return;
        }
        
        document.querySelector('.no-requests').style.display = 'none';
        
        requests.forEach(request => {
            const tr = document.createElement('tr');
            tr.setAttribute('role', 'row');
            
            tr.innerHTML = `
                <td role="cell">${request.id}</td>
                <td role="cell">${request.student.first_name} ${request.student.last_name}</td>
                <td role="cell">${request.item.name}</td>
                <td role="cell">${new Date(request.request_date).toLocaleDateString()}</td>
                <td role="cell">${new Date(request.return_date).toLocaleDateString()}</td>
                <td role="cell">
                    <span class="status-badge ${request.status}" aria-label="סטטוס: ${request.status}">
                        ${request.status}
                    </span>
                </td>
                <td role="cell">
                    <div class="action-buttons" role="group" aria-label="פעולות לבקשה">
                        <button type="button" 
                                class="btn-icon" 
                                onclick="showRequestDetails('${request.id}')"
                                aria-label="הצג פרטי בקשה">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${request.status === 'pending' ? `
                            <button type="button" 
                                    class="btn-icon" 
                                    onclick="approveRequest('${request.id}')"
                                    aria-label="אשר בקשה">
                                <i class="fas fa-check"></i>
                            </button>
                            <button type="button" 
                                    class="btn-icon" 
                                    onclick="rejectRequest('${request.id}')"
                                    aria-label="דחה בקשה">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                        ${request.status === 'approved' ? `
                            <button type="button" 
                                    class="btn-icon" 
                                    onclick="markAsReturned('${request.id}')"
                                    aria-label="סמן כהוחזר">
                                <i class="fas fa-undo"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            `;
            
            tbody.appendChild(tr);
        });
    }

    // Modal handling
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'block';
        modal.setAttribute('aria-hidden', 'false');
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
    }

    // Request details
    function showRequestDetails(requestId) {
        fetch(`/api/loan-requests/${requestId}`)
            .then(response => response.json())
            .then(request => {
                document.getElementById('detailsRequestId').textContent = request.id;
                document.getElementById('detailsStudent').textContent = 
                    `${request.student.first_name} ${request.student.last_name}`;
                document.getElementById('detailsItem').textContent = request.item.name;
                document.getElementById('detailsRequestDate').textContent = 
                    new Date(request.request_date).toLocaleDateString();
                document.getElementById('detailsReturnDate').textContent = 
                    new Date(request.return_date).toLocaleDateString();
                document.getElementById('detailsStatus').textContent = request.status;
                document.getElementById('detailsNotes').textContent = request.notes || 'אין הערות';
                
                showModal('requestDetailsModal');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('אירעה שגיאה בטעינת פרטי הבקשה');
            });
    }

    // Approve request
    function approveRequest(requestId) {
        if (confirm('האם אתה בטוח שברצונך לאשר את הבקשה?')) {
            fetch(`/api/loan-requests/${requestId}/approve`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('הבקשה אושרה בהצלחה');
                    window.location.reload();
                } else {
                    alert('אירעה שגיאה באישור הבקשה');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('אירעה שגיאה באישור הבקשה');
            });
        }
    }

    // Reject request
    function rejectRequest(requestId) {
        if (confirm('האם אתה בטוח שברצונך לדחות את הבקשה?')) {
            fetch(`/api/loan-requests/${requestId}/reject`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('הבקשה נדחתה בהצלחה');
                    window.location.reload();
                } else {
                    alert('אירעה שגיאה בדחיית הבקשה');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('אירעה שגיאה בדחיית הבקשה');
            });
        }
    }

    // Mark as returned
    function markAsReturned(requestId) {
        if (confirm('האם אתה בטוח שברצונך לסמן את הפריט כהוחזר?')) {
            fetch(`/api/loan-requests/${requestId}/return`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('הפריט סומן כהוחזר בהצלחה');
                    window.location.reload();
                } else {
                    alert('אירעה שגיאה בסימון הפריט כהוחזר');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('אירעה שגיאה בסימון הפריט כהוחזר');
            });
        }
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}