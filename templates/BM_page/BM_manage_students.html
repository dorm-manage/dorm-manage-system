{% extends 'base.html' %}
{% load static %}

{% block title %}ניהול סטודנטים - DormitoriesPlus{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="{% static 'css/forms.css' %}">
<style>
    .student-actions,
    .student-filters,
    .student-list {
        margin: 2rem 0;
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
    }

    .btn-primary,
    .btn-secondary {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-primary:hover,
    .btn-primary:focus {
        background-color: #0056b3;
    }

    .btn-secondary:hover,
    .btn-secondary:focus {
        background-color: #5a6268;
    }

    .filter-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .form-group label {
        font-weight: 500;
    }

    .form-group input,
    .form-group select {
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }

    .list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .status-summary {
        display: flex;
        gap: 1rem;
    }

    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
    }

    .status-badge.active {
        background-color: #28a745;
        color: white;
    }

    .status-badge.inactive {
        background-color: #dc3545;
        color: white;
    }

    .status-badge.pending {
        background-color: #ffc107;
        color: black;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .student-table {
        width: 100%;
        border-collapse: collapse;
    }

    .student-table th,
    .student-table td {
        padding: 0.75rem;
        text-align: right;
        border-bottom: 1px solid #ddd;
    }

    .student-table th {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    .btn-icon {
        padding: 0.5rem;
        background: none;
        border: none;
        cursor: pointer;
        color: #6c757d;
        transition: color 0.3s ease;
    }

    .btn-icon:hover,
    .btn-icon:focus {
        color: #007bff;
    }

    .no-students {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        position: relative;
        background-color: #fff;
        margin: 10% auto;
        padding: 1.5rem;
        width: 90%;
        max-width: 600px;
        border-radius: 8px;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
    }

    .close-btn:hover,
    .close-btn:focus {
        color: #dc3545;
    }

    .modal-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    @media (max-width: 768px) {
        .filter-form {
            grid-template-columns: 1fr;
        }

        .action-buttons {
            flex-direction: column;
        }

        .list-header {
            flex-direction: column;
            gap: 1rem;
        }

        .status-summary {
            flex-wrap: wrap;
        }

        .modal-content {
            width: 95%;
            margin: 5% auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="hero">
        <h2>ניהול סטודנטים</h2>
        <p>ברוך הבא, {{ user.first_name }} {{ user.last_name }}</p>
    </div>

    <div class="student-actions" role="region" aria-label="פעולות ניהול סטודנטים">
        <div class="action-buttons">
            <button type="button" 
                    class="btn-primary" 
                    onclick="showAddStudentModal()"
                    aria-label="הוסף סטודנט חדש">
                <i class="fas fa-user-plus"></i>
                הוסף סטודנט
            </button>
            <button type="button" 
                    class="btn-secondary" 
                    onclick="showStudentReport()"
                    aria-label="הצג דוח סטודנטים">
                <i class="fas fa-file-alt"></i>
                דוח סטודנטים
            </button>
        </div>
    </div>

    <div class="student-filters" role="region" aria-label="סינון סטודנטים">
        <h3>סינון סטודנטים</h3>
        <form id="filterForm" class="filter-form" role="search" aria-labelledby="filterFormTitle">
            <div class="form-group">
                <label for="building" id="building-label">בניין:</label>
                <select id="building" 
                        name="building" 
                        aria-labelledby="building-label">
                    <option value="">כל הבניינים</option>
                    {% for building in buildings %}
                    <option value="{{ building.id }}">{{ building.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="floor" id="floor-label">קומה:</label>
                <select id="floor" 
                        name="floor" 
                        aria-labelledby="floor-label">
                    <option value="">כל הקומות</option>
                </select>
            </div>

            <div class="form-group">
                <label for="room" id="room-label">חדר:</label>
                <select id="room" 
                        name="room" 
                        aria-labelledby="room-label">
                    <option value="">כל החדרים</option>
                </select>
            </div>

            <div class="form-group">
                <label for="status" id="status-label">סטטוס:</label>
                <select id="status" 
                        name="status" 
                        aria-labelledby="status-label">
                    <option value="">כל הסטטוסים</option>
                    <option value="active">פעיל</option>
                    <option value="inactive">לא פעיל</option>
                    <option value="pending">ממתין</option>
                </select>
            </div>

            <div class="form-group">
                <label for="search" id="search-label">חיפוש:</label>
                <input type="text" 
                       id="search" 
                       name="search" 
                       placeholder="חיפוש לפי שם או מספר סטודנט"
                       aria-labelledby="search-label">
            </div>

            <div class="form-actions">
                <button type="submit" 
                        class="btn-primary" 
                        aria-label="סנן סטודנטים">
                    סנן
                </button>
                <button type="reset" 
                        class="btn-secondary" 
                        aria-label="נקה סינון">
                    נקה
                </button>
            </div>
        </form>
    </div>

    <div class="student-list" role="region" aria-label="רשימת סטודנטים">
        <div class="list-header">
            <h3>רשימת סטודנטים</h3>
            <div class="status-summary" role="status" aria-label="סיכום סטטוסים">
                <span class="status-badge active" aria-label="פעיל: {{ active_count }}">
                    פעיל: {{ active_count }}
                </span>
                <span class="status-badge inactive" aria-label="לא פעיל: {{ inactive_count }}">
                    לא פעיל: {{ inactive_count }}
                </span>
                <span class="status-badge pending" aria-label="ממתין: {{ pending_count }}">
                    ממתין: {{ pending_count }}
                </span>
            </div>
        </div>

        {% if students %}
        <div class="table-responsive">
            <table class="student-table" role="grid" aria-label="רשימת סטודנטים">
                <thead>
                    <tr>
                        <th scope="col" role="columnheader">מספר סטודנט</th>
                        <th scope="col" role="columnheader">שם מלא</th>
                        <th scope="col" role="columnheader">בניין</th>
                        <th scope="col" role="columnheader">קומה</th>
                        <th scope="col" role="columnheader">חדר</th>
                        <th scope="col" role="columnheader">סטטוס</th>
                        <th scope="col" role="columnheader">פעולות</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr role="row">
                        <td role="cell">{{ student.student_id }}</td>
                        <td role="cell">{{ student.first_name }} {{ student.last_name }}</td>
                        <td role="cell">{{ student.building.name }}</td>
                        <td role="cell">{{ student.floor }}</td>
                        <td role="cell">{{ student.room }}</td>
                        <td role="cell">
                            <span class="status-badge {{ student.status }}" 
                                  aria-label="סטטוס: {{ student.status }}">
                                {{ student.status }}
                            </span>
                        </td>
                        <td role="cell">
                            <div class="action-buttons" role="group" aria-label="פעולות לסטודנט">
                                <button type="button" 
                                        class="btn-icon" 
                                        onclick="showStudentDetails('{{ student.id }}')"
                                        aria-label="הצג פרטי סטודנט">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" 
                                        class="btn-icon" 
                                        onclick="editStudent('{{ student.id }}')"
                                        aria-label="ערוך סטודנט">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" 
                                        class="btn-icon" 
                                        onclick="showStudentHistory('{{ student.id }}')"
                                        aria-label="הצג היסטוריית סטודנט">
                                    <i class="fas fa-history"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="no-students">לא נמצאו סטודנטים</p>
        {% endif %}
    </div>
</div>

<!-- Add Student Modal -->
<div id="addStudentModal" 
     class="modal" 
     role="dialog" 
     aria-labelledby="addStudentTitle" 
     aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="addStudentTitle">הוספת סטודנט חדש</h3>
            <button type="button" 
                    class="close-btn" 
                    onclick="closeModal('addStudentModal')"
                    aria-label="סגור חלון">
                &times;
            </button>
        </div>
        <form id="addStudentForm" class="modal-form" role="form" aria-labelledby="addStudentTitle">
            <div class="form-group">
                <label for="studentId" id="studentId-label">מספר סטודנט:</label>
                <input type="text" 
                       id="studentId" 
                       name="student_id" 
                       required 
                       aria-labelledby="studentId-label">
            </div>

            <div class="form-group">
                <label for="firstName" id="firstName-label">שם פרטי:</label>
                <input type="text" 
                       id="firstName" 
                       name="first_name" 
                       required 
                       aria-labelledby="firstName-label">
            </div>

            <div class="form-group">
                <label for="lastName" id="lastName-label">שם משפחה:</label>
                <input type="text" 
                       id="lastName" 
                       name="last_name" 
                       required 
                       aria-labelledby="lastName-label">
            </div>

            <div class="form-group">
                <label for="email" id="email-label">דוא"ל:</label>
                <input type="email" 
                       id="email" 
                       name="email" 
                       required 
                       aria-labelledby="email-label">
            </div>

            <div class="form-group">
                <label for="phone" id="phone-label">טלפון:</label>
                <input type="tel" 
                       id="phone" 
                       name="phone" 
                       required 
                       aria-labelledby="phone-label">
            </div>

            <div class="form-group">
                <label for="studentBuilding" id="studentBuilding-label">בניין:</label>
                <select id="studentBuilding" 
                        name="building" 
                        required 
                        aria-labelledby="studentBuilding-label">
                    <option value="">בחר בניין</option>
                    {% for building in buildings %}
                    <option value="{{ building.id }}">{{ building.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="studentFloor" id="studentFloor-label">קומה:</label>
                <select id="studentFloor" 
                        name="floor" 
                        required 
                        aria-labelledby="studentFloor-label">
                    <option value="">בחר קומה</option>
                </select>
            </div>

            <div class="form-group">
                <label for="studentRoom" id="studentRoom-label">חדר:</label>
                <select id="studentRoom" 
                        name="room" 
                        required 
                        aria-labelledby="studentRoom-label">
                    <option value="">בחר חדר</option>
                </select>
            </div>

            <div class="modal-footer">
                <button type="submit" 
                        class="btn-primary" 
                        aria-label="הוסף סטודנט">
                    הוסף
                </button>
                <button type="button" 
                        class="btn-secondary" 
                        onclick="closeModal('addStudentModal')"
                        aria-label="ביטול">
                    ביטול
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Student Details Modal -->
<div id="studentDetailsModal" 
     class="modal" 
     role="dialog" 
     aria-labelledby="studentDetailsTitle" 
     aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="studentDetailsTitle">פרטי סטודנט</h3>
            <button type="button" 
                    class="close-btn" 
                    onclick="closeModal('studentDetailsModal')"
                    aria-label="סגור חלון">
                &times;
            </button>
        </div>
        <div class="student-details" role="region" aria-label="פרטי סטודנט">
            <dl>
                <dt>מספר סטודנט:</dt>
                <dd id="detailsStudentId"></dd>
                
                <dt>שם מלא:</dt>
                <dd id="detailsFullName"></dd>
                
                <dt>דוא"ל:</dt>
                <dd id="detailsEmail"></dd>
                
                <dt>טלפון:</dt>
                <dd id="detailsPhone"></dd>
                
                <dt>בניין:</dt>
                <dd id="detailsBuilding"></dd>
                
                <dt>קומה:</dt>
                <dd id="detailsFloor"></dd>
                
                <dt>חדר:</dt>
                <dd id="detailsRoom"></dd>
                
                <dt>סטטוס:</dt>
                <dd id="detailsStatus"></dd>
                
                <dt>תאריך הצטרפות:</dt>
                <dd id="detailsJoinDate"></dd>
            </dl>
        </div>
        <div class="modal-footer">
            <button type="button" 
                    class="btn-secondary" 
                    onclick="closeModal('studentDetailsModal')"
                    aria-label="סגור">
                סגור
            </button>
        </div>
    </div>
</div>

<!-- Student History Modal -->
<div id="studentHistoryModal" 
     class="modal" 
     role="dialog" 
     aria-labelledby="studentHistoryTitle" 
     aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="studentHistoryTitle">היסטוריית סטודנט</h3>
            <button type="button" 
                    class="close-btn" 
                    onclick="closeModal('studentHistoryModal')"
                    aria-label="סגור חלון">
                &times;
            </button>
        </div>
        <div class="student-history" role="region" aria-label="היסטוריית סטודנט">
            <div id="historyList" class="history-list"></div>
        </div>
        <div class="modal-footer">
            <button type="button" 
                    class="btn-secondary" 
                    onclick="closeModal('studentHistoryModal')"
                    aria-label="סגור">
                סגור
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Filter form handling
    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const params = new URLSearchParams(formData);
        
        fetch(`/api/students?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                updateStudentList(data.students);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('אירעה שגיאה בטעינת הסטודנטים');
            });
    });

    // Update student list
    function updateStudentList(students) {
        const tbody = document.querySelector('.student-table tbody');
        tbody.innerHTML = '';
        
        if (students.length === 0) {
            document.querySelector('.no-students').style.display = 'block';
            return;
        }
        
        document.querySelector('.no-students').style.display = 'none';
        
        students.forEach(student => {
            const tr = document.createElement('tr');
            tr.setAttribute('role', 'row');
            
            tr.innerHTML = `
                <td role="cell">${student.student_id}</td>
                <td role="cell">${student.first_name} ${student.last_name}</td>
                <td role="cell">${student.building.name}</td>
                <td role="cell">${student.floor}</td>
                <td role="cell">${student.room}</td>
                <td role="cell">
                    <span class="status-badge ${student.status}" aria-label="סטטוס: ${student.status}">
                        ${student.status}
                    </span>
                </td>
                <td role="cell">
                    <div class="action-buttons" role="group" aria-label="פעולות לסטודנט">
                        <button type="button" 
                                class="btn-icon" 
                                onclick="showStudentDetails('${student.id}')"
                                aria-label="הצג פרטי סטודנט">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" 
                                class="btn-icon" 
                                onclick="editStudent('${student.id}')"
                                aria-label="ערוך סטודנט">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" 
                                class="btn-icon" 
                                onclick="showStudentHistory('${student.id}')"
                                aria-label="הצג היסטוריית סטודנט">
                            <i class="fas fa-history"></i>
                        </button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(tr);
        });
    }

    // Modal handling
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'block';
        modal.setAttribute('aria-hidden', 'false');
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
    }

    // Add student
    function showAddStudentModal() {
        document.getElementById('addStudentForm').reset();
        showModal('addStudentModal');
    }

    document.getElementById('addStudentForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch('/api/students', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('הסטודנט נוסף בהצלחה');
                closeModal('addStudentModal');
                window.location.reload();
            } else {
                alert('אירעה שגיאה בהוספת הסטודנט');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('אירעה שגיאה בהוספת הסטודנט');
        });
    });

    // Student details
    function showStudentDetails(studentId) {
        fetch(`/api/students/${studentId}`)
            .then(response => response.json())
            .then(student => {
                document.getElementById('detailsStudentId').textContent = student.student_id;
                document.getElementById('detailsFullName').textContent = 
                    `${student.first_name} ${student.last_name}`;
                document.getElementById('detailsEmail').textContent = student.email;
                document.getElementById('detailsPhone').textContent = student.phone;
                document.getElementById('detailsBuilding').textContent = student.building.name;
                document.getElementById('detailsFloor').textContent = student.floor;
                document.getElementById('detailsRoom').textContent = student.room;
                document.getElementById('detailsStatus').textContent = student.status;
                document.getElementById('detailsJoinDate').textContent = 
                    new Date(student.join_date).toLocaleDateString();
                
                showModal('studentDetailsModal');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('אירעה שגיאה בטעינת פרטי הסטודנט');
            });
    }

    // Student history
    function showStudentHistory(studentId) {
        fetch(`/api/students/${studentId}/history`)
            .then(response => response.json())
            .then(history => {
                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                
                if (history.length === 0) {
                    historyList.innerHTML = '<p class="no-history">אין היסטוריה לסטודנט זה</p>';
                    return;
                }
                
                history.forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerHTML = `
                        <div class="history-date">${new Date(entry.date).toLocaleString()}</div>
                        <div class="history-action">${entry.action}</div>
                        <div class="history-details">${entry.details}</div>
                    `;
                    historyList.appendChild(div);
                });
                
                showModal('studentHistoryModal');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('אירעה שגיאה בטעינת היסטוריית הסטודנט');
            });
    }

    // Edit student
    function editStudent(studentId) {
        // Implement edit functionality
        alert('פונקציונליות עריכת סטודנט תיושם בקרוב');
    }

    // Show student report
    function showStudentReport() {
        // Implement report functionality
        alert('פונקציונליות דוח סטודנטים תיושם בקרוב');
    }

    // Building, floor, and room selection handling
    document.getElementById('building').addEventListener('change', function() {
        updateFloorOptions(this.value);
    });

    document.getElementById('floor').addEventListener('change', function() {
        updateRoomOptions(document.getElementById('building').value, this.value);
    });

    document.getElementById('studentBuilding').addEventListener('change', function() {
        updateStudentFloorOptions(this.value);
    });

    document.getElementById('studentFloor').addEventListener('change', function() {
        updateStudentRoomOptions(
            document.getElementById('studentBuilding').value, 
            this.value
        );
    });

    function updateFloorOptions(buildingId) {
        const floorSelect = document.getElementById('floor');
        floorSelect.innerHTML = '<option value="">כל הקומות</option>';
        
        if (!buildingId) return;
        
        fetch(`/api/buildings/${buildingId}/floors`)
            .then(response => response.json())
            .then(floors => {
                floors.forEach(floor => {
                    const option = document.createElement('option');
                    option.value = floor;
                    option.textContent = `קומה ${floor}`;
                    floorSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('אירעה שגיאה בטעינת הקומות');
            });
    }

    function updateRoomOptions(buildingId, floor) {
        const roomSelect = document.getElementById('room');
        roomSelect.innerHTML = '<option value="">כל החדרים</option>';
        
        if (!buildingId || !floor) return;
        
        fetch(`/api/buildings/${buildingId}/floors/${floor}/rooms`)
            .then(response => response.json())
            .then(rooms => {
                rooms.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room;
                    option.textContent = `חדר ${room}`;
                    roomSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('אירעה שגיאה בטעינת החדרים');
            });
    }

    function updateStudentFloorOptions(buildingId) {
        const floorSelect = document.getElementById('studentFloor');
        floorSelect.innerHTML = '<option value="">בחר קומה</option>';
        
        if (!buildingId) return;
        
        fetch(`/api/buildings/${buildingId}/floors`)
            .then(response => response.json())
            .then(floors => {
                floors.forEach(floor => {
                    const option = document.createElement('option');
                    option.value = floor;
                    option.textContent = `קומה ${floor}`;
                    floorSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('אירעה שגיאה בטעינת הקומות');
            });
    }

    function updateStudentRoomOptions(buildingId, floor) {
        const roomSelect = document.getElementById('studentRoom');
        roomSelect.innerHTML = '<option value="">בחר חדר</option>';
        
        if (!buildingId || !floor) return;
        
        fetch(`/api/buildings/${buildingId}/floors/${floor}/rooms`)
            .then(response => response.json())
            .then(rooms => {
                rooms.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room;
                    option.textContent = `חדר ${room}`;
                    roomSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('אירעה שגיאה בטעינת החדרים');
            });
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}